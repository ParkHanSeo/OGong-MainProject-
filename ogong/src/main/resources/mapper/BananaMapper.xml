<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper
		PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
		"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
		
<mapper namespace="com.ogong.service.banana.BananaMapper">
	
	
	<resultMap id="BananaSelectMap" type="banana">
		<result property="bananaNo"        		 column="BANANA_INFO_NO"       jdbcType="NUMERIC"/>
		<result property="bananaEmail.email"     column="BANANA_EMAIL"         jdbcType="VARCHAR"/>
		<result property="bananaAmount"      	 column="BANANA_AMOUNT"        jdbcType="NUMERIC"/>
		<result property="bananaHistoryDate"	 column="BANANA_HISTORY_DATE"  jdbcType="DATE"/>
		<result property="bananaHistory"    	 column="BANANA_HISTORY"       jdbcType="VARCHAR"/>
		<result property="bananaCategory"	 	 column="BANANA_CATEGORY"	   jdbcType="VARCHAR"/>
	</resultMap>

	<resultMap id="UserSelectMap" type="user">
		<result property="email"						 column="EMAIL"				 jdbcType="VARCHAR"/>
		<result property="condition"					 column="CONDITION"			 jdbcType="VARCHAR"/>
		<result property="nickname"					   	 column="NICKNAME"			 jdbcType="VARCHAR"/>
		<result property="withdrawDate"					 column="WITHDRAW_DATE"		 jdbcType="VARCHAR"/>
		<result property="withdrawReason"				 column="WITHDRAW_REASON"	 jdbcType="VARCHAR"/>
		<result property="restoreDate"					 column="RESTORE_DATE"		 jdbcType="VARCHAR"/>
		<result property="restoreReason"				 column="RESTORE_REASON"	 jdbcType="VARCHAR"/>
		<result property="userTargetTime"				 column="USER_TARGET_TIME"	 jdbcType="NUMERIC"/>
		<result property="regDate"						 column="REG_DATE"			 jdbcType="VARCHAR"/>
		<result property="suspendStartDate"				 column="SUSPEND_START_DATE" jdbcType="VARCHAR"/>
		<result property="suspendEndDate"				 column="SUSPEND_END_DATE"   jdbcType="VARCHAR"/>
		<result property="bananaCount"				 	 column="BANANA_COUNT"   	 jdbcType="NUMERIC"/>
	</resultMap>	
	
	<!-- 바나나 인서트 -->
	<insert id="addBanana"	parameterType="banana" useGeneratedKeys="true" keyColumn="banana_info_no" keyProperty="bananaNo">
		INSERT
		INTO BANANA_INFO (banana_info_no
					,banana_email
					,banana_amount
					,banana_history_date
					,banana_history
					,banana_category)
			VALUES	(seq_banana_info_no.nextVal
					,#{bananaEmail.email:VARCHAR}
					,#{bananaAmount:NUMERIC}
					,SYSDATE
					,#{bananaHistory:VARCHAR}
					,#{bananaCategory:VARCHAR}
					)
	</insert>
	
	<select id="getlistAcquireBanana" parameterType="hashmap" resultMap="BananaSelectMap">
		SELECT outer_table.*
		FROM ( SELECT 
			   inner_table.* , ROWNUM AS row_seq
						FROM		( SELECT b.banana_email,
											 b.banana_history,
											 TO_CHAR(b.banana_history_date,'YYYY-MM-DD') banana_history_date,
											 b.banana_amount
											 FROM users u, banana_info b
										  	 WHERE u.email = b.banana_email
											 AND    b.banana_category = '1'
											  ) inner_table
						   				WHERE ROWNUM &lt;= #{search.endRowNum}) outer_table
									WHERE row_seq BETWEEN #{search.startRowNum} AND #{search.endRowNum}
	</select>
	
	
	<select id="getlistUseBanana" parameterType="hashmap" resultMap="BananaSelectMap">
		SELECT outer_table.*
		FROM ( SELECT 
			   inner_table.* , ROWNUM AS row_seq
						FROM		( SELECT b.banana_email,
											 b.banana_history,
											 TO_CHAR(b.banana_history_date,'YYYY-MM-DD') banana_history_date,
											 b.banana_amount
											 FROM users u, banana_info b
										  	 WHERE u.email = b.banana_email
											 AND    b.banana_category = '2'
											  ) inner_table
						   				WHERE ROWNUM &lt;= #{search.endRowNum}) outer_table
									WHERE row_seq BETWEEN #{search.startRowNum} AND #{search.endRowNum}
	</select>	
	

	<update id="updateAcquireBanana" parameterType="user">
		UPDATE users
		
		SET	banana_count = BANANA_COUNT + #{bananaCount:NUMERIC}
		
		WHERE email = #{email:VARCHAR}
	</update>	
	
	<update id="updateUseBanana" parameterType="user">
		UPDATE users
		<set>
			banana_count = banana_count - #{bananaCount:NUMERIC}
		</set>
		WHERE email = #{email:VARCHAR}
	</update>	
	
	
	<select id="getAcquireCount"		parameterType="hashmap"		resultType="int">
		SELECT COUNT(*)
						FROM		( SELECT b.banana_email,
											 b.banana_history,
											 TO_CHAR(b.banana_history_date,'YYYY-MM-DD') banana_history_date,
											 b.banana_amount
											 FROM users u, banana_info b
										  	 WHERE u.email = b.banana_email
											 AND    b.banana_category = '1'
											 ) countTable
	</select>	
	
	<select id="getUseCount"		parameterType="hashmap"		resultType="int">
		SELECT COUNT(*)
						FROM		( SELECT b.banana_email,
											 b.banana_history,
											 TO_CHAR(b.banana_history_date,'YYYY-MM-DD') banana_history_date,
											 b.banana_amount
											 FROM users u, banana_info b
										  	 WHERE u.email = b.banana_email
											 AND    b.banana_category = '2'
											 ) countTable
	</select>	
	
</mapper>







